// This query is designed to find the vulnerabilities on systems with a specific tag
// Previously was used to find vulnerabilities based on the MachineGroup, this is commented out now
//
// Author: GVI ONE Cyber Team
// License: GPL3
//
DeviceInfo
//| where isnotempty (DeviceName) and MachineGroup == "AAA Workstations"
// Only search systems with a specific agency tag - CHANGE AS NEEDED
| where DeviceManualTags contains "AAA"
| distinct DeviceName, MachineGroup, DeviceManualTags
// Join DeviceTvmSoftwareVulnerabilities and DeviceTvmSoftwareVulnerabilitiesKB
| join kind=leftouter (DeviceTvmSoftwareVulnerabilities
// If the output hits the 10k table row limit, you can uncomment the below line to narrow things down
//    | where VulnerabilitySeverityLevel != "Low"
//    | where VulnerabilitySeverityLevel == "High"
    | join kind=leftouter (DeviceTvmSoftwareVulnerabilitiesKB) on CveId) on DeviceName
// Project only what we want
| project 
    MachineGroup,
    DeviceManualTags,
    DeviceName,
    OSPlatform,
    OSVersion,
    SoftwareVendor,
    SoftwareName,
    SoftwareVersion,
    VulnerabilitySeverityLevel,
    IsExploitAvailable,
    VulnerabilityDescription,
    RecommendedSecurityUpdate,
    PublishedDate,
    LastModifiedTime,
    CveId
// Show only unique entries
| distinct *
// Sort Output by DeviceName
| sort by DeviceName asc
